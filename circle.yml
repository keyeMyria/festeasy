machine:
  python:
    version: 3.4.2
  node:
    version: 0.10.33

dependencies:
  cache_directories:
    - ~/nvm/v0.10.33/
    - www/node_modules/
  pre:
    - sudo apt-get update; sudo apt-get -y install python3-dev gcc
    - sudo ldconfig
  override:
    - npm install -g firebase-tools
    - if [ ! -e ~/nvm/v0.10.33/bin/gulp ]; then npm install -g gulp; else echo "gulp seems to be cached."; fi;
    - cd www && bower install
    - pip install -r requirements.txt
    - cd www && npm install
    - cd www && bower install

test:
  override:
    - nose2 --plugin nose2.plugins.junitxml --junit-xml
  post:
    - cp ./nose2-junit.xml $CIRCLE_TEST_REPORTS

deployment:
  staging:
    branch: staging
    commands:
      - curl http://festeasy-staging.herokuapp.com:
          background: true
      - echo "angular.module('conf', []).constant('API_END_POINT', 'http://festeasy-staging.herokuapp.com/api/v1');" > www/src/app/settings.coffee
      - cd www && gulp
      - git push -f git@heroku.com:festeasy-staging.git $CIRCLE_SHA1:master
      - cd www && firebase deploy -f festeasy-staging --token=$FIREBASE_TOKEN --non-interactive
  production:
    branch: production
    commands:
      - curl http://festeasy-production.herokuapp.com:
          background: true
      - echo "angular.module('conf', []).constant('API_END_POINT', 'http://festeasy-production.herokuapp.com/api/v1');" > www/src/app/settings.coffee
      - cd www && gulp
      - git push -f git@heroku.com:festeasy-production.git $CIRCLE_SHA1:master
      - cd www && firebase deploy -f festeasy-production --token=$FIREBASE_TOKEN --non-interactive
