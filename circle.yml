machine:
  python:
    version: 3.5.0
  node:
    version: 4.2.2

dependencies:
  cache_directories:
    - /home/ubuntu/nvm/versions/node/4.2.2/bin
    - /home/ubuntu/nvm/versions/node/4.2.2/lib/node_modules
  pre:
    - sudo apt-get update; sudo apt-get -y install python3-dev gcc
  override:
    - npm install -g firebase-tools@2.2.0 netlify-cli gulp webpack eslint
    - pip install -r requirements.txt
    - python ./configure_api_endpoints.py -e $CIRCLE_BRANCH
    - cd www; npm install
    - cd www; bower install
    - cd www; gulp
    - cd admin_www; npm install
    - cd admin_www; bower install
    - cd admin_www; gulp
    - cd new_www; npm install
    - cd new_www; webpack

test:
  override:
    - cd backend; python manage.py -c testing run-tests -j tests.xml
  post:
    - cd backend; cp ./tests.xml $CIRCLE_TEST_REPORTS

deployment:
  staging:
    branch: staging
    commands:
      - curl http://festeasy-staging.herokuapp.com:
          background: true
      - git push -f git@heroku.com:festeasy-staging.git $CIRCLE_SHA1:master
      - cd www; firebase deploy -f festeasy-staging --token=$FIREBASE_TOKEN --non-interactive
      - cd admin_www; firebase deploy -f fe-admin-staging --token=$FIREBASE_TOKEN --non-interactive
  production:
    branch: production
    commands:
      - curl http://festeasy-production.herokuapp.com:
          background: true
      - git push -f git@heroku.com:festeasy-production.git $CIRCLE_SHA1:master
      - cd www; firebase deploy -f festeasy-production --token=$FIREBASE_TOKEN --non-interactive
      - cd admin_www; firebase deploy -f fe-admin-production --token=$FIREBASE_TOKEN --non-interactive
